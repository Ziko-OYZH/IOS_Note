# 操作系统

### 操作系统的特征

- 并发	（指两个或多个事件在**同一时间间隔内**发生。这些事件宏观上是同时发生的，但微观上是交替发生的，而 **并行**：指两个或者多个事件在**同一时刻同时发生**）
- 共享        （即资源共享，是指系统中的资源可供内存中多个并发执行的程序共同使用。**互斥共享方式**：可以提供给多个进程使用，但是一个时间段内只允许一个进程访问该资源  **同时共享方式**：允许一个时间段有多个进程“同时”对它们进行访问）
- 虚拟         （虚拟是指把一个物理上的实体变为若干个逻辑上的对应物，物理实体是实际存在的，而逻辑上对应物是用户感受到的。**空分复用技术**：如虚拟存储器技术  **时分复用技术**：如虚拟处理器）
- 异步          （）

其中，并发和共享是最基本的两个特征

**对于单核CPU而言，同一时刻只能执行一个程序，各个程序只能<u>并发</u>的执行**

**多核CPU同一时刻可以同时执行多个程序，多个程序可以<u>并行</u>的执行**



### 内核态与用户态

CPU有两种状态，内核态和用户态

- 处于内核态时，说明此时运行的是内核程序，此时可以执行特权指令
- 处于用户态时，说明此时正在运行的是应用程序，此时可能执行非特权指令



**CPU中有一个寄存器叫程序状态字寄存器（PSW），其中有个二进制位，1表示内核态，0表示用户态**



### 中断和异常

用户态->内核态：由中断引发，硬件自动完成变态过程，触发中断信号意味着操作系统将强行拿回CPU的使用权

**CPU上会运行两种程序，一种是操作系统内核程序，一种是应用程序**

**中断会使CPU由用户态变为内核态，是操作系统重新夺回对CPU的控制权**

在合适的情况下，操作系统内核会把CPU的使用权主动让给应用程序

**“中断”是让操作系统内核夺回CPU使用权的唯一途径（系统调用，异常，任务切换）**



中断的类型

- 内中断（与当前执行的指令有关，中断信号来源于CPU内部）：试图在用户态下执行特权指令；执行除法时发现除数为0；应用程序想请求操作系统内核的服务，此时会执行一条特殊的指令--陷入指令，该指令会引发一个内部中断信号（系统调用）
- 外中断（与当前执行的指令无关，中断信号来源于CPU外部）：时钟中断；I/O中断由输入输出设备发来的中断信号



**内中断（异常、例外）**

- 陷阱、陷入（trap）：由陷入指令引发，应用程序故意引发
- 故障（fault）：有错误条件引起，可能被内核程序修复，内核程序修复故障后会把CPU使用权还给应用程序，让它继续执行下去，比如缺页故障
- 终止（abort）：由致命错误引起的，内核程序无法修复错误，因此一般不再将CPU使用权还给引发终止的应用程序，而是直接终止该应用程序，比如整数除0，非法使用特权指令



**外中断（中断）**

- 时钟中断
- I/O中断





![image-20240307144720456](/Users/oyzh/Library/Application Support/typora-user-images/image-20240307144720456.png)







### 操作系统体系结构

![image-20240307152214320](/Users/oyzh/Library/Application Support/typora-user-images/image-20240307152214320.png)





![image-20240307152657631](/Users/oyzh/Library/Application Support/typora-user-images/image-20240307152657631.png)



操作系统引导

- CPU从一个特定主存地址开始，取指令，执行ROM中的引导程序（先进行硬件自检，再开机）
- 将磁盘的第一块--主引导记录（MBR）读入内存，执行磁盘引导程序，并扫描分区表
- 从活动分区（又称主分区，即安装了操作系统的分区）读入分区引导记录，执行其中的程序
- 从根目录下找到完整的操作系统初始化程序（即 启动管理器）并执行，完成“开机”的一系列操作



![image-20240307160414208](/Users/oyzh/Library/Application Support/typora-user-images/image-20240307160414208.png)





### 进程

程序：是静态的，就是存放咋磁盘里的可执行文件，就是一系列指令的集合

进程：是动态的，是程序的一次执行过程



### PCB进程控制块

PCB是进程存在的唯一标志，当进程被创建时，操作系统会为其创建PCB，当进程结束时，会回收其PCB



- 进程描述信息
  - 进程标识符PID
  - 用户标识符UID
- 进程控制和管理信息
  - CPU、磁盘、网络流量使用情况统计
  - 进程当前状态：就绪态、阻塞态、运行态...
- 资源分配清单
  - 正在使用哪些文件
  - 正在使用哪些内存区域
  - 正在使用哪些I/O设备
- 处理机相关信息
  - 如PSW、PC等等各种寄存器的值（用于实现进程切换）



### 进程的组成

- PCB
- 程序段
- 数据段

PCB是给操作系统用的

程序段数据段是给进程自己用的

**一个进程的实体由 PCB 程序段 数据段 组成**

**进程是进程实体的运行过程，是系统进行资源分配和调度的一个独立单位**



### 进程的特性

- 动态性
- 并发性
- 独立性
- 异步性
- 结构性



### 进程的状态与转换

- 创建态：进程正在被创建时，它的状态是创建态，在这个阶段操作系统会为进程分配资源，初始化PCB
- 就绪态：当进程创建完成后，便进入就绪态，处于就绪态的进程已经具备运行条件，但由于没有空闲CPU，暂时不能运行
- 运行态：如果一个进程此时在CPU上运行，那么这个进程处于“运行态”，CPU会执行该进程对应的程序（执行指令序列）
- 阻塞态 
- 终止态



![image-20240307173852844](/Users/oyzh/Library/Application Support/typora-user-images/image-20240307173852844.png)



**进程PCB中，会有一个变量state来表示进程当前的状态**



### 进程控制

  实现进程状态转换



### 如何实现原语的“原子性”

原语的执行具有原子性，即执行过程只能一气呵成，期间不允许被中断，可以用“关中断指令”和“开中断指令”这两个特权指令实现原子性。（CPU在执行完每条指令后，要检查是否有外部中断信号，如果有则暂停运行当前这段程序，转而执行相应中断处理程序。而当CPU执行了关中断指令之后，就不再例行检查中断信号，直到开中断指令之后才会恢复检查，对于其中的中断程序要等CPU打开中断之后再去处理）



### 进程创建相关的原语

- 创建原语
  - 申请空白PCB
  - 为新进程分配所需资源
  - 初始化PCB
  - 将PCB插入就绪队列（创建态->就绪态）
- 引起进程创建的事件
  - 用户登录：分时系统中，用户登录成功，系统会为其建立一个新进程
  - 作业调度：多道批处理系统中，有新的作业放入内存中，会为其建立一个新的进程
  - 提供服务：用户向操作系统提出某些请求时，会新建一个进程处理该请求
  - 应用请求：由用户进程主动请求创建一个子进程



- 撤销原语
  - 从PCB集合中找到终止进程的PCB
  - 若进程正在运行，立即剥夺CPU，将CPU分配给其他进程
  - 终止其所有子进程
  - 将该进程拥有的所有资源归还给父进程或操作系统
  - 删除PCB
- 引起进程终止的事件
  - 正常结束（进程自己请求终止 exit）
  - 异常结束（整数除0）
  - 外界干预



- 阻塞原语（运行态->阻塞态）
  - 找到要阻塞的进程对应的PCB
  - 保护进程运行现场，将PCB状态信息设置为阻塞态，暂时停止进程运行
  - 将PCB插入相应事件的等待队列

- 引起进程阻塞的事件
  - 需要等待系统分配某种资源
  - 需要等待相互合作的其他进程完成工作



- 唤醒原语（阻塞态->就绪态）
  - 在等待事件队列中找到PCB
  - 将PCB从等待队列移除，设置进程为就绪态
  - 将PCB插入就绪队列，等待被调度
- 引起进程唤醒的事件
  - 等待的事件发生（因何事阻塞，就应有何事唤醒）



- 切换原语（运行 就绪 相互切换）
  - 将进程运行环境存入PCB
  - PCB移入相应队列
  - 选择另一个进程执行，并更新其PCB
  - 根据PCB恢复新进程所需的运行环境

- 引起进程切换的事件
  - 当前进程时间片到
  - 有更高优先级的进程到达
  - 当前进程主动阻塞
  - 当前进程终止